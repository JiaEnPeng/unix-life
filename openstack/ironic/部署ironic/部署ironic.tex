% !TeX spellcheck = en_US
%% 字体：方正静蕾简体
%%		 方正粗宋
\documentclass[a4paper,left=1.5cm,right=1.5cm,11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{fontspec}
\usepackage{cite}
\usepackage{xeCJK}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{etoolbox}%
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}%
\patchcmd{\ttlh@hang}{\noindent}{}{}{}%
\makeatother
\usepackage{hyperref}
\usepackage{longtable}
\usepackage{empheq}
\usepackage{graphicx}
\usepackage{float}
\usepackage{rotating}
\usepackage{subfigure}
\usepackage{tabu}
\usepackage{amsmath}
\usepackage{setspace}
\usepackage{amsfonts}
\usepackage{appendix}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{geometry}
\setcounter{secnumdepth}{4}
%\titleformat*{\section}{\LARGE}
%\renewcommand\refname{参考文献}
%\titleformat{\chapter}{\centering\bfseries\huge}{}{0.7em}{}{}
\titleformat{\section}{\LARGE\bf}{\thesection}{1em}{}{}
\titleformat{\subsection}{\Large\bfseries}{\thesubsection}{1em}{}{}
\titleformat{\subsubsection}{\large\bfseries}{\thesubsubsection}{1em}{}{}
\renewcommand{\contentsname}{{ \centerline{目{  } 录}}}
\setCJKfamilyfont{cjkhwxk}{STXINGKA.TTF}
%\setCJKfamilyfont{cjkhwxk}{华文行楷}
%\setCJKfamilyfont{cjkfzcs}{方正粗宋简体}
%\newcommand*{\cjkfzcs}{\CJKfamily{cjkfzcs}}
\newcommand*{\cjkhwxk}{\CJKfamily{cjkhwxk}}
%\newfontfamily\wryh{Microsoft YaHei}
%\newfontfamily\hwzs{华文中宋}
%\newfontfamily\hwst{华文宋体}
%\newfontfamily\hwfs{华文仿宋}
%\newfontfamily\jljt{方正静蕾简体}
%\newfontfamily\hwxk{华文行楷}
\newcommand{\verylarge}{\fontsize{60pt}{\baselineskip}\selectfont}  
\newcommand{\chuhao}{\fontsize{44.9pt}{\baselineskip}\selectfont}  
\newcommand{\xiaochu}{\fontsize{38.5pt}{\baselineskip}\selectfont}  
\newcommand{\yihao}{\fontsize{27.8pt}{\baselineskip}\selectfont}  
\newcommand{\xiaoyi}{\fontsize{25.7pt}{\baselineskip}\selectfont}  
\newcommand{\erhao}{\fontsize{23.5pt}{\baselineskip}\selectfont}  
\newcommand{\xiaoerhao}{\fontsize{19.3pt}{\baselineskip}\selectfont} 
\newcommand{\sihao}{\fontsize{14pt}{\baselineskip}\selectfont}      % 字号设置  
\newcommand{\xiaosihao}{\fontsize{12pt}{\baselineskip}\selectfont}  % 字号设置  
\newcommand{\wuhao}{\fontsize{10.5pt}{\baselineskip}\selectfont}    % 字号设置  
\newcommand{\xiaowuhao}{\fontsize{9pt}{\baselineskip}\selectfont}   % 字号设置  
\newcommand{\liuhao}{\fontsize{7.875pt}{\baselineskip}\selectfont}  % 字号设置  
\newcommand{\qihao}{\fontsize{5.25pt}{\baselineskip}\selectfont}    % 字号设置 

\usepackage{diagbox}
\usepackage{multirow}
\boldmath
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
\definecolor{cred}{rgb}{0.8,0.8,0.8}
\definecolor{cgreen}{rgb}{0,0.3,0}
\definecolor{cpurple}{rgb}{0.5,0,0.35}
\definecolor{cdocblue}{rgb}{0,0,0.3}
\definecolor{cdark}{rgb}{0.95,1.0,1.0}
\lstset{
	language=bash,
	numbers=left,
	numberstyle=\tiny\color{black},
	showspaces=false,
	showstringspaces=false,
	basicstyle=\scriptsize,
	keywordstyle=\color{purple},
	commentstyle=\color{cgreen},
	stringstyle=\color{blue},
	frame=lines,
	% escapeinside=``,
	extendedchars=true, 
	xleftmargin=1em,
	xrightmargin=1em, 
	backgroundcolor=\color{cred},
	aboveskip=1em,
	breaklines=true,
	tabsize=4
} 

%\newfontfamily{\consolas}{Consolas}
%\newfontfamily{\monaco}{Monaco}
%\setmonofont[Mapping={}]{Consolas}	%英文引号之类的正常显示，相当于设置英文字体
%\setsansfont{Consolas} %设置英文字体 Monaco, Consolas,  Fantasque Sans Mono
%\setmainfont{Times New Roman}
%\setCJKmainfont{STZHONGS.TTF}
%\setmonofont{Consolas}
% \newfontfamily{\consolas}{YaHeiConsolas.ttf}
\newfontfamily{\monaco}{MONACO.TTF}
\setCJKmainfont{STZHONGS.TTF}
%\setmainfont{MONACO.TTF}
%\setsansfont{MONACO.TTF}

\newcommand{\fic}[1]{\begin{figure}[H]
		\center
		\includegraphics[width=0.8\textwidth]{#1}
	\end{figure}}
	
\newcommand{\sizedfic}[2]{\begin{figure}[H]
		\center
		\includegraphics[width=#1\textwidth]{#2}
	\end{figure}}

\newcommand{\codefile}[1]{\lstinputlisting{#1}}

\newcommand{\interval}{\vspace{0.5em}}

\newcommand{\tablestart}{
	\interval
	\begin{longtable}{p{2cm}p{10cm}}
	\hline}
\newcommand{\tableend}{
	\hline
	\end{longtable}
	\interval}

% 改变段间隔
\setlength{\parskip}{0.2em}
\linespread{1.1}

\usepackage{lastpage}
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{\space \qquad \space}
\chead{部署ironic \qquad}
\rhead{\qquad\thepage/\pageref{LastPage}}

\begin{document}

\tableofcontents

\clearpage

\section{环境配置}
	\begin{lstlisting}
	rm -f /opt/stack/data/ca-bundle.pem
	\end{lstlisting}

	环境变量：
	\begin{lstlisting}
	BASE_SQL_CONN=mysql+pymysql://root:p1111111@127.0.0.1
	DATA_DIR=/opt/stack/data
	DEST=/opt/stack
	ENABLED_SERVICES=key,n-api,n-cpu,n-cond,n-sch,n-cauth,placement-api,placement-client,g-api,g-reg,q-svc,q-dhcp,q-meta,q-agt,q-l3,rabbit,tempest,mysql,dstat,s-proxy,s-object,s-container,s-account,ironic,ir-api,ir-cond
	HOST_IP=10.250.1.3 # devstack在stackrc中调用get_default_host_ip获取host ip
	KEYSTONE_AUTH_PROTOCOL=http
	KEYSTONE_AUTH_URI=http://10.250.1.3/identity_admin
	KEYSTONE_SERVICE_URI=http://10.250.1.3/identity
	LOGFILE=/home/pengsida/temp/devstack.log.2017-03-23-142947
	OS_CACERT=
	SERVICE_HOST=10.250.1.3
	SERVICE_PROTOCOL=http
	STACK_USER=pengsida
	TLS_IP=
	HOST_IPV6=::1
	SERVICE_IP_VERSION=4
	\end{lstlisting}

	需要装的包：
	\begin{lstlisting}
	bc bridge-utils bsdmainutils curl g++ gcc gettext git graphviz iputils-ping libffi-dev libjpeg-dev libmysqlclient-dev libpq-dev libssl-dev libxml2-dev libxslt1-dev libyaml-dev lsof openssh-server openssl pkg-config psmisc python2.7 python-dev python-gdbm screen tar tcpdump unzip uuid-runtime wget wget zlib1g-dev libkrb5-dev libldap2-dev libsasl2-dev memcached python-mysqldb sqlite3 fping conntrack curl dnsmasq-base dnsmasq-utils ebtables gawk genisoimage iptables iputils-arping kpartx libjs-jquery-tablesorter libmysqlclient-dev parted pm-utils python-mysqldb socat sqlite3 sudo vlan cryptsetup genisoimage gir1.2-libosinfo-1.0 open-iscsi qemu-utils sg3-utils sysfsutils acl dnsmasq-base ebtables haproxy iptables iputils-arping iputils-ping libmysqlclient-dev postgresql-server-dev-all python-mysqldb sqlite3 sudo vlan ipset conntrack conntrackd keepalived dstat curl liberasurecode-dev make memcached sqlite3 xfsprogs apparmor docker.io ipmitool iptables ipxe gnupg libguestfs0 libguestfs-tools libvirt-bin open-iscsi openssh-client python-libguestfs python-libvirt qemu qemu-kvm qemu-utils sgabios shellinabox syslinux tftpd-hpa xinetd squashfs-tools libvirt-dev socat ipxe-qemu
	\end{lstlisting}

	下载ironic源码：
	\begin{lstlisting}
	git clone http://git.trystack.cn/openstack/ironic /opt/stack/ironic
	\end{lstlisting}

	设置数据库：
	\begin{lstlisting}
	mysql+pymysql://root:p1111111@127.0.0.1
	\end{lstlisting}

	下载requirements：
	\begin{lstlisting}
	git clone http://git.trystack.cn/openstack/requirements.git /opt/stack/requirements master
	\end{lstlisting}

	更新源：
	\begin{lstlisting}
	sudo http_proxy= https_proxy= no_proxy=  apt-get update
	\end{lstlisting}

	安装包：
	\begin{lstlisting}
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install bc bridge-utils bsdmainutils curl g++ gcc gettext git graphviz iputils-ping libffi-dev libjpeg-dev libmysqlclient-dev libpq-dev libssl-dev libxml2-dev libxslt1-dev libyaml-dev lsof openssh-server openssl pkg-config psmisc python2.7 python-dev python-gdbm screen tar tcpdump unzip uuid-runtime wget wget zlib1g-dev libkrb5-dev libldap2-dev libsasl2-dev memcached python-mysqldb sqlite3 fping conntrack curl dnsmasq-base dnsmasq-utils ebtables gawk genisoimage iptables iputils-arping kpartx libjs-jquery-tablesorter libmysqlclient-dev parted pm-utils python-mysqldb socat sqlite3 sudo vlan cryptsetup genisoimage gir1.2-libosinfo-1.0 open-iscsi qemu-utils sg3-utils sysfsutils acl dnsmasq-base ebtables haproxy iptables iputils-arping iputils-ping libmysqlclient-dev postgresql-server-dev-all python-mysqldb sqlite3 sudo vlan ipset conntrack conntrackd keepalived dstat curl liberasurecode-dev make memcached sqlite3 xfsprogs apparmor docker.io ipmitool iptables ipxe gnupg libguestfs0 libguestfs-tools libvirt-bin open-iscsi openssh-client python-libguestfs python-libvirt qemu qemu-kvm qemu-utils sgabios shellinabox syslinux tftpd-hpa xinetd squashfs-tools libvirt-dev socat ipxe-qemu
	\end{lstlisting}

	卸载python-pip和python3-pip：
	\begin{lstlisting}
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes purge python-pip
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes purge python3-pip
	\end{lstlisting}

	下载get-pip.py
	\begin{lstlisting}
	curl -f --retry 6 --retry-delay 5 -z /home/pengsida/devstack/files/get-pip.py -o /home/pengsida/devstack/files/get-pip.py https://bootstrap.pypa.io/get-pip.py
	\end{lstlisting}

	安装pip：
	\begin{lstlisting}
	sudo -H -E python /home/pengsida/devstack/files/get-pip.py -c /home/pengsida/devstack/tools/cap-pip.txt
	\end{lstlisting}

	安装python的包：
	\begin{lstlisting}
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'setuptools>=16.0,!=24.0.0,!=34.0.0,!=34.0.1,!=34.0.2,!=34.0.3,!=34.1.0,!=34.1.1,!=34.2.0,!=34.3.0,!=34.3.1,!=34.3.2'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -U os-testr
	\end{lstlisting}

	为keystone设置ipv4的保留端口：
	\begin{lstlisting}
	keystone_ports=${KEYSTONE_AUTH_PORT:-35357},${KEYSTONE_AUTH_PORT_INT:-35358}
	reserved_ports=$(sysctl net.ipv4.ip_local_reserved_ports | awk -F'=' '{print $2;}' | sed 's/^ //')
	if [[ -z "${reserved_ports}" ]]; then
        sudo sysctl -w net.ipv4.ip_local_reserved_ports=${keystone_ports}
    else
        sudo sysctl -w net.ipv4.ip_local_reserved_ports=${keystone_ports},${reserved_ports}
    fi
	\end{lstlisting}

	安装并配置prettytable包：
	\begin{lstlisting}
	# 安装prettytable包
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'prettytable>=0.7'
	# 获取prettytable包的目录
	PACKAGE_DIR=$(python -c 'import os; import prettytable; print(os.path.split(os.path.realpath(prettytable.__file__))[0])')
	dir=$(echo $PACKAGE_DIR/prettytable-0.7.2*)
	# 设置该目录下的文件可读
	if [[ -d $dir ]]; then
		sudo chmod +r $dir/*
	fi
	\end{lstlisting}

	安装并配置httplib2包：
	\begin{lstlisting}
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt httplib2
	PACKAGE_DIR=$(python -c 'import os; import httplib2; print(os.path.split(os.path.realpath(httplib2.__file__))[0])')
	dir=$(echo $PACKAGE_DIR/prettytable-0.7.2*)
	if [[ -d $dir ]]; then
		sudo chmod +r $dir/*
	fi
	\end{lstlisting}

	安装python-virtualenv包：
	\begin{lstlisting}
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install python-virtualenv
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -U --force-reinstall virtualenv
	\end{lstlisting}

	安装infra：
	\begin{lstlisting}
	env http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /opt/stack/requirements/.venv/bin/pip install -c /opt/stack/requirements/upper-constraints.txt -U pbr
	env http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /opt/stack/requirements/.venv/bin/pip install -c /opt/stack/requirements/upper-constraints.txt /opt/stack/requirements
	env http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /opt/stack/requirements/.venv/bin/pip install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/requirements/test-requirements.txt
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -U pbr
	\end{lstlisting}

	其他的pre-install：
	\begin{lstlisting}
	# 这里只是设置环境变量，没有安装包
	source /opt/stack/ironic/devstack/lib/ironic
	\end{lstlisting}

	安装并配置rpc-backend：
	\begin{lstlisting}
	# 安装rabbitmq-server
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install rabbitmq-server
	# 配置rabbitmq-server
	sudo rabbitmqctl list_users
	sudo rabbitmqctl change_password stackrabbit p1111111
	sudo rabbitmqctl set_permissions stackrabbit '.*' '.*' '.*'
	sudo rabbitmqctl change_password stackrabbit p1111111
	\end{lstlisting}

	安装并配置database：
	\begin{lstlisting}
	# 设置deb-conf database，使得安装mysql时不需要密码
	DATABASE_PASSWORD=p1111111
	sudo debconf-set-selections <<MYSQL_PRESEED
mysql-server mysql-server/root_password password $DATABASE_PASSWORD
mysql-server mysql-server/root_password_again password $DATABASE_PASSWORD
mysql-server mysql-server/start_on_boot boolean true
MYSQL_PRESEED

	# it is useful as it allows you to access the mysql databases via ``mysql nova`` instead of having to specify the username/password each time.
	cat <<EOF >$HOME/.my.cnf
[client]
user=$DATABASE_USER
password=$DATABASE_PASSWORD
host=$MYSQL_HOST
EOF
	chmod 0600 $HOME/.my.cnf

	# 安装mysql
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install mysql-server
	# 安装PyMySQL
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'PyMySQL>=0.7.6'
	\end{lstlisting}

	安装并配置neutron-agent-packages：
	\begin{lstlisting}
	# 安装包
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install radvd
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install fakeroot make openvswitch-switch
	# 如果内核版本小于3.13,还需要安装“dkms openvswitch-datapath-dkms linux-headers-$kernel_version”

	# 重启openvswitch-switch服务
	sudo service openvswitch-switch restart
	\end{lstlisting}

	安装OpenStack project source：
	\begin{lstlisting}
	# 安装keystonemiddleware
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'keystonemiddleware>=4.12.0'
	# 安装python-memcached
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'python-memcached>=1.56'

	# 安装并配置keystone
	# ==================

	# 安装keystone相关的包
	git clone http://git.trystack.cn/openstack/keystone.git /opt/stack/keystone
	/opt/stack/requirements/.venv/bin/edit-constraints /opt/stack/requirements/upper-constraints.txt -- keystone '-e file:///opt/stack/keystone#egg=keystone'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -e /opt/stack/keystone
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/keystone/test-requirements.txt
	sudo chown -R pengsida /opt/stack/keystone/keystone.egg-info

	# 安装apache、wsgi
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install apache2
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install libapache2-mod-wsgi

	# 配置keystone
	sudo install -d -o pengsida /etc/keystone
	600 /opt/stack/keystone/etc/keystone.conf.sample /etc/keystone/keystone.conf
    cp -p /opt/stack/keystone/etc/policy.json /etc/keystone
    cp -p /opt/stack/keystone/etc/keystone-paste.ini /etc/keystone/keystone-paste.ini
    iniset /etc/keystone/keystone.conf paste_deploy config_file /etc/keystone/keystone-paste.ini
	# 配置keystone相关设置
	iniset /etc/keystone/keystone.conf identity driver sql
    iniset /etc/keystone/keystone.conf assignment driver sql
    iniset /etc/keystone/keystone.conf role driver sql
    iniset /etc/keystone/keystone.conf resource driver sql
    iniset /etc/keystone/keystone.conf cache enabled True
    iniset /etc/keystone/keystone.conf cache backend dogpile.cache.memcached
    iniset /etc/keystone/keystone.conf cache memcache_servers localhost:11211
	# 配置rpc-backend相关设置
	iniset /etc/keystone/keystone.conf DEFAULT transport_url rabbit://stackrabbit:p1111111@10.250.1.3:5672/
	# 配置keystone相关设置
	iniset /etc/keystone/keystone.conf DEFAULT public_endpoint http://10.250.1.3/identity
    iniset /etc/keystone/keystone.conf DEFAULT admin_endpoint http://10.250.1.3/identity_admin
	iniset /etc/keystone/keystone.conf token provider fernet
	iniset /etc/keystone/keystone.conf database connection 'mysql+pymysql://root:p1111111@127.0.0.1/keystone?charset=utf8'
    iniset /etc/keystone/keystone.conf token driver sql
	iniset /etc/keystone/keystone.conf DEFAULT debug True
	iniset /etc/keystone/keystone.conf DEFAULT logging_exception_prefix '%(asctime)s.%(msecs)03d %(process)d TRACE %(name)s %(instance)s'
	# 配置apache、wsgi的相关设置
	sudo cp /home/pengsida/devstack/files/apache-keystone.template /etc/apache2/sites-available/keystone.conf
	sudo sed -e '
         s|%PUBLICPORT%|5000|g;
         s|%ADMINPORT%|35357|g;
         s|%APACHE_NAME%|apache2|g;
         s|%SSLLISTEN%|#|g;
         s|%SSLENGINE%||g;
         s|%SSLCERTFILE%||g;
         s|%SSLKEYFILE%||g;
         s|%USER%|pengsida|g;
         s|%VIRTUALENV%||g
         s|%KEYSTONE_BIN%|/usr/local/bin|g
     ' -i /etc/apache2/sites-available/keystone.conf
	# 配置keystone相关设置
	iniset /etc/keystone/keystone.conf DEFAULT max_token_size 16384
    iniset /etc/keystone/keystone.conf fernet_tokens key_repository /etc/keystone/fernet-keys/
    iniset /etc/keystone/keystone.conf credential key_repository /etc/keystone/credential-keys/
	iniset /etc/keystone/keystone.conf security_compliance lockout_failure_attempts 2
    iniset /etc/keystone/keystone.conf security_compliance lockout_duration 5
    iniset /etc/keystone/keystone.conf security_compliance unique_last_password_count 2

	# 安装并配置swift
	# ==================

	# 安装swift相关的包
	git clone http://git.trystack.cn/openstack/swift.git /opt/stack/swift master
	/opt/stack/requirements/.venv/bin/edit-constraints /opt/stack/requirements/upper-constraints.txt -- swift '-e file:///opt/stack/swift#egg=swift'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -e /opt/stack/swift
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/swift/test-requirements.txt
	sudo chown -R pengsida /opt/stack/swift/swift.egg-info

	# 配置swift
	swift-init --run-dir=/opt/stack/data/swift/run all stop
	sudo install -d -o pengsida /etc/swift
    sudo install -d -o pengsida /etc/swift/object-server /etc/swift/container-server /etc/swift/account-server
	sed -e '
		s/%GROUP%//;
		s/%USER%/pengsida/;
		s,%SWIFT_DATA_DIR%,/opt/stack/data/swift,;
	' /home/pengsida/devstack/files/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
	sudo sed -i '/^RSYNC_ENABLE=false/ { s/false/true/ }' /etc/default/rsync
	cp /opt/stack/swift/etc/proxy-server.conf-sample /etc/swift/proxy-server.conf
	cp /opt/stack/swift/etc/container-sync-realms.conf-sample /etc/swift/container-sync-realms.conf
    iniset /etc/swift/container-sync-realms.conf realm1 key realm1key
    iniset /etc/swift/container-sync-realms.conf realm1 cluster_name1 http://10.250.1.3:8080/v1/
    iniuncomment /etc/swift/proxy-server.conf DEFAULT user
    iniset /etc/swift/proxy-server.conf DEFAULT user pengsida
    iniuncomment /etc/swift/proxy-server.conf DEFAULT swift_dir
    iniset /etc/swift/proxy-server.conf DEFAULT swift_dir /etc/swift
    iniuncomment /etc/swift/proxy-server.conf DEFAULT workers
    iniset /etc/swift/proxy-server.conf DEFAULT workers 1
    iniuncomment /etc/swift/proxy-server.conf DEFAULT log_level
    iniset /etc/swift/proxy-server.conf DEFAULT log_level DEBUG
    iniuncomment /etc/swift/proxy-server.conf DEFAULT bind_ip
    iniset /etc/swift/proxy-server.conf DEFAULT bind_ip 0.0.0.0
    iniuncomment /etc/swift/proxy-server.conf DEFAULT bind_port
	iniset /etc/swift/proxy-server.conf app:proxy-server node_timeout 120
    iniset /etc/swift/proxy-server.conf app:proxy-server conn_timeout 20
    iniset /etc/swift/proxy-server.conf filter:versioned_writes allow_versioned_writes true
	iniset /etc/swift/proxy-server.conf filter:proxy-logging reveal_sensitive_prefix 12
	sed -i '/^pipeline/ { s/tempauth/crossdomain authtoken keystoneauth tempauth  formpost staticweb/ ;}' /etc/swift/proxy-server.conf
	sed -i '/^pipeline/ { s/proxy-server/ proxy-server/ ; }' /etc/swift/proxy-server.conf
    iniset /etc/swift/proxy-server.conf app:proxy-server account_autocreate true
    iniset /etc/swift/proxy-server.conf app:proxy-server allow_account_management true
    iniset /etc/swift/proxy-server.conf filter:crossdomain use egg:swift#crossdomain
    iniset /etc/swift/proxy-server.conf filter:authtoken log_name swift
    iniset /etc/swift/proxy-server.conf filter:authtoken paste.filter_factory keystonemiddleware.auth_token:filter_factory
	# 配置auth-token的middleware
	iniset /etc/swift/proxy-server.conf filter:authtoken auth_type password
    iniset /etc/swift/proxy-server.conf filter:authtoken auth_url http://10.250.1.3/identity_admin
    iniset /etc/swift/proxy-server.conf filter:authtoken username swift
    iniset /etc/swift/proxy-server.conf filter:authtoken password p1111111
    iniset /etc/swift/proxy-server.conf filter:authtoken user_domain_name Default
    iniset /etc/swift/proxy-server.conf filter:authtoken project_name service
    iniset /etc/swift/proxy-server.conf filter:authtoken project_domain_name Default
    iniset /etc/swift/proxy-server.conf filter:authtoken auth_uri http://10.250.1.3/identity
    iniset /etc/swift/proxy-server.conf filter:authtoken cafile /opt/stack/data/ca-bundle.pem
    iniset /etc/swift/proxy-server.conf filter:authtoken signing_dir /var/cache/swift
    iniset /etc/swift/proxy-server.conf filter:authtoken memcached_servers 10.250.1.3:11211
    iniset /etc/swift/proxy-server.conf filter:authtoken delay_auth_decision 1
    iniset /etc/swift/proxy-server.conf filter:authtoken cache swift.cache
    iniset /etc/swift/proxy-server.conf filter:authtoken include_service_catalog False
    iniset /etc/swift/proxy-server.conf filter:keystoneauth use egg:swift#keystoneauth
    iniset /etc/swift/proxy-server.conf filter:keystoneauth operator_roles 'Member, admin'
    iniuncomment /etc/swift/proxy-server.conf filter:tempauth account_autocreate
    iniset /etc/swift/proxy-server.conf filter:tempauth reseller_prefix TEMPAUTH
	# 配置swift相关设置
	cp /opt/stack/swift/etc/swift.conf-sample /etc/swift/swift.conf
    iniset /etc/swift/swift.conf swift-hash swift_hash_path_suffix p1111111
    iniset /etc/swift/swift.conf swift-constraints max_header_size 16384
    iniset /etc/swift/swift.conf swift-constraints max_file_size 5368709122
	# 配置swift-node-1
	cp /opt/stack/swift/etc/object-server.conf-sample /etc/swift/object-server/1.conf
	iniuncomment /etc/swift/object-server/1.conf DEFAULT user
    iniset /etc/swift/object-server/1.conf DEFAULT user pengsida
    iniuncomment /etc/swift/object-server/1.conf DEFAULT bind_port
    iniset /etc/swift/object-server/1.conf DEFAULT bind_port 6613
    iniuncomment /etc/swift/object-server/1.conf DEFAULT swift_dir
    iniset /etc/swift/object-server/1.conf DEFAULT swift_dir /etc/swift
    iniuncomment /etc/swift/object-server/1.conf DEFAULT devices
    iniset /etc/swift/object-server/1.conf DEFAULT devices /opt/stack/data/swift/1
    iniuncomment /etc/swift/object-server/1.conf DEFAULT log_facility
    iniset /etc/swift/object-server/1.conf DEFAULT log_facility LOG_LOCAL0
    iniuncomment /etc/swift/object-server/1.conf DEFAULT workers
    iniset /etc/swift/object-server/1.conf DEFAULT workers 2
    iniuncomment /etc/swift/object-server/1.conf DEFAULT disable_fallocate
    iniset /etc/swift/object-server/1.conf DEFAULT disable_fallocate true
    iniuncomment /etc/swift/object-server/1.conf DEFAULT mount_check
    iniset /etc/swift/object-server/1.conf DEFAULT mount_check false
    iniuncomment /etc/swift/object-server/1.conf object-replicator vm_test_mode
    iniset /etc/swift/object-server/1.conf object-replicator vm_test_mode yes
    sed -i -e 's,#[ ]*recon_cache_path .*,recon_cache_path = /opt/stack/data/swift/cache,' /etc/swift/object-server/1.conf
    iniuncomment /etc/swift/object-server/1.conf DEFAULT bind_ip
    iniset /etc/swift/object-server/1.conf DEFAULT bind_ip 0.0.0.0
    iniset /etc/swift/object-server/1.conf filter:recon recon_cache_path /opt/stack/data/swift/cache
	# 配置swift-container-server-1
	cp /opt/stack/swift/etc/container-server.conf-sample /etc/swift/container-server/1.conf
	iniuncomment /etc/swift/container-server/1.conf DEFAULT user
    iniset /etc/swift/container-server/1.conf DEFAULT user pengsida
    iniuncomment /etc/swift/container-server/1.conf DEFAULT bind_port
    iniset /etc/swift/container-server/1.conf DEFAULT bind_port 6611
    iniuncomment /etc/swift/container-server/1.conf DEFAULT swift_dir
    iniset /etc/swift/container-server/1.conf DEFAULT swift_dir /etc/swift
    iniuncomment /etc/swift/container-server/1.conf DEFAULT devices
    iniset /etc/swift/container-server/1.conf DEFAULT devices /opt/stack/data/swift/1
    iniuncomment /etc/swift/container-server/1.conf DEFAULT log_facility
    iniset /etc/swift/container-server/1.conf DEFAULT log_facility LOG_LOCAL0
    iniuncomment /etc/swift/container-server/1.conf DEFAULT workers
    iniset /etc/swift/container-server/1.conf DEFAULT workers 2
    iniuncomment /etc/swift/container-server/1.conf DEFAULT disable_fallocate
    iniset /etc/swift/container-server/1.conf DEFAULT disable_fallocate true
    iniuncomment /etc/swift/container-server/1.conf DEFAULT mount_check
    iniset /etc/swift/container-server/1.conf DEFAULT mount_check false
    iniuncomment /etc/swift/container-server/1.conf container-replicator vm_test_mode
    iniset /etc/swift/container-server/1.conf container-replicator vm_test_mode yes
    sed -i -e 's,#[ ]*recon_cache_path .*,recon_cache_path = /opt/stack/data/swift/cache,' /etc/swift/container-server/1.conf
    iniuncomment /etc/swift/container-server/1.conf DEFAULT bind_ip
    iniset /etc/swift/container-server/1.conf DEFAULT bind_ip 0.0.0.0
	# 配置account-server-1
	cp /opt/stack/swift/etc/account-server.conf-sample /etc/swift/account-server/1.conf
	iniuncomment /etc/swift/account-server/1.conf DEFAULT user
    iniset /etc/swift/account-server/1.conf DEFAULT user pengsida
    iniuncomment /etc/swift/account-server/1.conf DEFAULT bind_port
    iniset /etc/swift/account-server/1.conf DEFAULT bind_port 6612
    iniuncomment /etc/swift/account-server/1.conf DEFAULT swift_dir
    iniset /etc/swift/account-server/1.conf DEFAULT swift_dir /etc/swift
    iniuncomment /etc/swift/account-server/1.conf DEFAULT devices
    iniset /etc/swift/account-server/1.conf DEFAULT devices /opt/stack/data/swift/1
    iniuncomment /etc/swift/account-server/1.conf DEFAULT log_facility
    iniset /etc/swift/account-server/1.conf DEFAULT log_facility LOG_LOCAL0
    iniuncomment /etc/swift/account-server/1.conf DEFAULT workers
    iniset /etc/swift/account-server/1.conf DEFAULT workers 2
    iniuncomment /etc/swift/account-server/1.conf DEFAULT disable_fallocate
    iniset /etc/swift/account-server/1.conf DEFAULT disable_fallocate true
    iniuncomment /etc/swift/account-server/1.conf DEFAULT mount_check
    iniset /etc/swift/account-server/1.conf DEFAULT mount_check false
    iniuncomment /etc/swift/account-server/1.conf account-replicator vm_test_mode
    iniset /etc/swift/account-server/1.conf account-replicator vm_test_mode yes
    sed -i -e 's,#[ ]*recon_cache_path .*,recon_cache_path = /opt/stack/data/swift/cache,' /etc/swift/account-server/1.conf
    iniuncomment /etc/swift/account-server/1.conf DEFAULT bind_ip
    iniset /etc/swift/account-server/1.conf DEFAULT bind_ip 0.0.0.0
	# Set new accounts in tempauth to match keystone project/user (to make testing easier)
	iniset /etc/swift/proxy-server.conf filter:tempauth user_swiftprojecttest1_swiftusertest1 'testing .admin'
    iniset /etc/swift/proxy-server.conf filter:tempauth user_swiftprojecttest2_swiftusertest2 'testing2 .admin'
    iniset /etc/swift/proxy-server.conf filter:tempauth user_swiftprojecttest1_swiftusertest3 'testing3 .admin'
	cp /opt/stack/swift/test/sample.conf /etc/swift/test.conf
    iniset /etc/swift/test.conf func_test account swiftprojecttest1
    iniset /etc/swift/test.conf func_test username swiftusertest1
    iniset /etc/swift/test.conf func_test username3 swiftusertest3
    iniset /etc/swift/test.conf func_test account2 swiftprojecttest2
    iniset /etc/swift/test.conf func_test username2 swiftusertest2
    iniset /etc/swift/test.conf func_test account4 swiftprojecttest4
    iniset /etc/swift/test.conf func_test username4 swiftusertest4
    iniset /etc/swift/test.conf func_test password4 testing4
    iniset /etc/swift/test.conf func_test domain4 swift_test
	iniuncomment /etc/swift/test.conf func_test auth_version
	iniget /etc/swift/test.conf func_test auth_version
	iniset /etc/swift/test.conf func_test auth_host 10.250.1.3
    iniset /etc/swift/test.conf func_test auth_port 35357
    iniset /etc/swift/test.conf func_test auth_prefix /v3/
	sudo install -d -o pengsida -g 1000 /opt/stack/data/swift
	sudo rm -rf /opt/stack/data/swift/logs
	sudo install -d -o pengsida -g adm /opt/stack/data/swift/logs/hourly

	# 安装并配置glance
	# ==================

	git clone http://git.trystack.cn/openstack/glance.git /opt/stack/glance
	/opt/stack/requirements/.venv/bin/edit-constraints /opt/stack/requirements/upper-constraints.txt -- glance '-e file:///opt/stack/glance#egg=glance'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -e /opt/stack/glance
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/glance/test-requirements.txt
	sudo chown -R pengsida /opt/stack/glance/glance.egg-info

	sudo install -d -o pengsida /etc/glance /etc/glance/metadefs

	# 配置glance-registry
    cp /opt/stack/glance/etc/glance-registry.conf /etc/glance/glance-registry.conf
    iniset /etc/glance/glance-registry.conf DEFAULT debug True
    iniset /etc/glance/glance-registry.conf DEFAULT bind_host 0.0.0.0
    inicomment /etc/glance/glance-registry.conf DEFAULT log_file
	iniset /etc/glance/glance-registry.conf database connection 'mysql+pymysql://root:p1111111@127.0.0.1/glance?charset=utf8'
    iniset /etc/glance/glance-registry.conf DEFAULT use_syslog False
    iniset /etc/glance/glance-registry.conf DEFAULT workers 2
    iniset /etc/glance/glance-registry.conf paste_deploy flavor keystone
	# 配置auth-token的middleware
	iniset /etc/glance/glance-registry.conf keystone_authtoken auth_type password
    iniset /etc/glance/glance-registry.conf keystone_authtoken auth_url http://10.250.1.3/identity_admin
    iniset /etc/glance/glance-registry.conf keystone_authtoken username glance
    iniset /etc/glance/glance-registry.conf keystone_authtoken password p1111111
    iniset /etc/glance/glance-registry.conf keystone_authtoken user_domain_name Default
    iniset /etc/glance/glance-registry.conf keystone_authtoken project_name service
    iniset /etc/glance/glance-registry.conf keystone_authtoken project_domain_name Default
    iniset /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://10.250.1.3/identity
    iniset /etc/glance/glance-registry.conf keystone_authtoken cafile /opt/stack/data/ca-bundle.pem
    iniset /etc/glance/glance-registry.conf keystone_authtoken signing_dir /var/cache/glance/registry
    iniset /etc/glance/glance-registry.conf keystone_authtoken memcached_servers 10.250.1.3:11211
    iniset /etc/glance/glance-registry.conf oslo_messaging_notifications driver messagingv2
    # 配置rpc-backend
	iniset /etc/glance/glance-registry.conf DEFAULT transport_url rabbit://stackrabbit:p1111111@10.250.1.3:5672/
	iniset /etc/glance/glance-registry.conf DEFAULT graceful_shutdown_timeout 5

	# 配置glance-api
    cp /opt/stack/glance/etc/glance-api.conf /etc/glance/glance-api.conf
    iniset /etc/glance/glance-api.conf DEFAULT debug True
    iniset /etc/glance/glance-api.conf DEFAULT bind_host 0.0.0.0
    inicomment /etc/glance/glance-api.conf DEFAULT log_file
    iniset /etc/glance/glance-api.conf database connection 'mysql+pymysql://root:p1111111@127.0.0.1/glance?charset=utf8'
    iniset /etc/glance/glance-api.conf DEFAULT use_syslog False
    iniset /etc/glance/glance-api.conf DEFAULT image_cache_dir /opt/stack/data/glance/cache/
    iniset /etc/glance/glance-api.conf paste_deploy flavor keystone+cachemanagement
	# 配置auth-token的middleware
	iniset /etc/glance/glance-api.conf keystone_authtoken auth_type password
    iniset /etc/glance/glance-api.conf keystone_authtoken auth_url http://10.250.1.3/identity_admin
    iniset /etc/glance/glance-api.conf keystone_authtoken username glance
    iniset /etc/glance/glance-api.conf keystone_authtoken password p1111111
    iniset /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default
    iniset /etc/glance/glance-api.conf keystone_authtoken project_name service
    iniset /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default
    iniset /etc/glance/glance-api.conf keystone_authtoken auth_uri http://10.250.1.3/identity
    iniset /etc/glance/glance-api.conf keystone_authtoken cafile /opt/stack/data/ca-bundle.pem
    iniset /etc/glance/glance-api.conf keystone_authtoken signing_dir /var/cache/glance/api
    iniset /etc/glance/glance-api.conf keystone_authtoken memcached_servers 10.250.1.3:11211
    iniset /etc/glance/glance-api.conf oslo_messaging_notifications driver messagingv2
	# 配置rpc-backend
	iniset /etc/glance/glance-api.conf DEFAULT transport_url rabbit://stackrabbit:p1111111@10.250.1.3:5672/
	iniset /etc/glance/glance-api.conf DEFAULT enable_v1_api False
    iniset /etc/glance/glance-api.conf glance_store filesystem_store_datadir /opt/stack/data/glance/images/
    iniset /etc/glance/glance-api.conf DEFAULT registry_host 10.250.1.3
    iniset /etc/glance/glance-api.conf DEFAULT workers 2
	iniset /etc/glance/glance-api.conf cors allowed_origin http://10.250.1.3
	iniset /etc/glance/glance-api.conf glance_store default_store swift
    iniset /etc/glance/glance-api.conf glance_store swift_store_create_container_on_put True
	iniset /etc/glance/glance-api.conf glance_store swift_store_config_file /etc/glance/glance-swift-store.conf
    iniset /etc/glance/glance-api.conf glance_store default_swift_reference ref1
    iniset /etc/glance/glance-api.conf glance_store stores 'file, http, swift'
    iniset /etc/glance/glance-api.conf DEFAULT graceful_shutdown_timeout 5
	iniset /etc/glance/glance-swift-store.conf ref1 user service:glance-swift
    iniset /etc/glance/glance-swift-store.conf ref1 key p1111111
	iniset /etc/glance/glance-swift-store.conf ref1 auth_address http://10.250.1.3/identity/v3
    iniset /etc/glance/glance-swift-store.conf ref1 auth_version 3
    inicomment /etc/glance/glance-api.conf glance_store swift_store_user
    inicomment /etc/glance/glance-api.conf glance_store swift_store_key
    inicomment /etc/glance/glance-api.conf glance_store swift_store_auth_address
	# Format logging
	iniset /etc/glance/glance-api.conf DEFAULT logging_context_format_string '%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(project_name)s %(user_name)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m'
    iniset /etc/glance/glance-api.conf DEFAULT logging_default_format_string '%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m'
	iniset /etc/glance/glance-api.conf DEFAULT logging_exception_prefix '%(color)s%(asctime)s.%(msecs)03d TRACE %(name)s [01;35m%(instance)s[00m'
	iniset /etc/glance/glance-api.conf DEFAULT logging_debug_format_suffix '[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m'
	iniset /etc/glance/glance-registry.conf DEFAULT logging_context_format_string '%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(project_name)s %(user_name)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m'
    iniset /etc/glance/glance-registry.conf DEFAULT logging_default_format_string '%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m'
	iniset /etc/glance/glance-registry.conf DEFAULT logging_debug_format_suffix '[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m'
	iniset /etc/glance/glance-registry.conf DEFAULT logging_exception_prefix '%(color)s%(asctime)s.%(msecs)03d TRACE %(name)s [01;35m%(instance)s[00m'
	cp -p /opt/stack/glance/etc/glance-registry-paste.ini /etc/glance/glance-registry-paste.ini
    cp -p /opt/stack/glance/etc/glance-api-paste.ini /etc/glance/glance-api-paste.ini
    cp /opt/stack/glance/etc/glance-cache.conf /etc/glance/glance-cache.conf
    iniset /etc/glance/glance-cache.conf DEFAULT debug True
    inicomment /etc/glance/glance-cache.conf DEFAULT log_file
    iniset /etc/glance/glance-cache.conf DEFAULT use_syslog False
    iniset /etc/glance/glance-cache.conf DEFAULT image_cache_dir /opt/stack/data/glance/cache/
    iniuncomment /etc/glance/glance-cache.conf DEFAULT auth_url
    iniset /etc/glance/glance-cache.conf DEFAULT auth_url http://10.250.1.3/identity_admin/v3
    iniuncomment /etc/glance/glance-cache.conf DEFAULT auth_tenant_name
    iniset /etc/glance/glance-cache.conf DEFAULT admin_tenant_name service
    iniuncomment /etc/glance/glance-cache.conf DEFAULT auth_user
    iniset /etc/glance/glance-cache.conf DEFAULT admin_user glance
    iniuncomment /etc/glance/glance-cache.conf DEFAULT auth_password
    iniset /etc/glance/glance-cache.conf DEFAULT admin_password p1111111
    iniset /etc/glance/glance-cache.conf DEFAULT registry_host 10.250.1.3
	# Store specific confs
    iniset /etc/glance/glance-cache.conf glance_store filesystem_store_datadir /opt/stack/data/glance/images/
	cp -p /opt/stack/glance/etc/policy.json /etc/glance/policy.json
    cp -p /opt/stack/glance/etc/schema-image.json /etc/glance/schema-image.json
    cp -p /opt/stack/glance/etc/metadefs/cim-processor-allocation-setting-data.json /opt/stack/glance/etc/metadefs/cim-resource-allocation-setting-data.json /opt/stack/glance/etc/metadefs/cim-storage-allocation-setting-data.json /opt/stack/glance/etc/metadefs/cim-virtual-system-setting-data.json /opt/stack/glance/etc/metadefs/compute-aggr-disk-filter.json /opt/stack/glance/etc/metadefs/compute-aggr-iops-filter.json /opt/stack/glance/etc/metadefs/compute-aggr-num-instances.json /opt/stack/glance/etc/metadefs/compute-cpu-pinning.json /opt/stack/glance/etc/metadefs/compute-guest-memory-backing.json /opt/stack/glance/etc/metadefs/compute-guest-shutdown.json /opt/stack/glance/etc/metadefs/compute-host-capabilities.json /opt/stack/glance/etc/metadefs/compute-hypervisor.json /opt/stack/glance/etc/metadefs/compute-instance-data.json /opt/stack/glance/etc/metadefs/compute-libvirt-image.json /opt/stack/glance/etc/metadefs/compute-libvirt.json /opt/stack/glance/etc/metadefs/compute-quota.json /opt/stack/glance/etc/metadefs/compute-randomgen.json /opt/stack/glance/etc/metadefs/compute-trust.json /opt/stack/glance/etc/metadefs/compute-vcputopology.json /opt/stack/glance/etc/metadefs/compute-vmware-flavor.json /opt/stack/glance/etc/metadefs/compute-vmware-quota-flavor.json /opt/stack/glance/etc/metadefs/compute-vmware.json /opt/stack/glance/etc/metadefs/compute-watchdog.json /opt/stack/glance/etc/metadefs/compute-xenapi.json /opt/stack/glance/etc/metadefs/glance-common-image-props.json /opt/stack/glance/etc/metadefs/image-signature-verification.json /opt/stack/glance/etc/metadefs/operating-system.json /opt/stack/glance/etc/metadefs/software-databases.json /opt/stack/glance/etc/metadefs/software-runtimes.json /opt/stack/glance/etc/metadefs/software-webservers.json /opt/stack/glance/etc/metadefs/storage-volume-type.json /etc/glance/metadefs


	# 安装并配置neutron
	# ==================

	git clone http://git.trystack.cn/openstack/neutron.git /opt/stack/neutron
	/opt/stack/requirements/.venv/bin/edit-constraints /opt/stack/requirements/upper-constraints.txt -- neutron '-e file:///opt/stack/neutron#egg=neutron'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -e /opt/stack/neutron
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/neutron/test-requirements.txt
	sudo chown -R pengsida /opt/stack/neutron/neutron.egg-info

	# 安装并配置nova
	# ==================

	# 安装nova-hypervisor
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install qemu-system
	sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install libvirt-bin libvirt-dev
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt 'libvirt-python>=1.2.5'
	sudo rm -rf /usr/share/qemu/sgabios.bin
	sudo cp /usr/share/misc/sgabios.bin /usr/share/qemu/sgabios.bin

	# 安装nova
	git clone http://git.trystack.cn/openstack/nova.git /opt/stack/nova
	/opt/stack/requirements/.venv/bin/edit-constraints /opt/stack/requirements/upper-constraints.txt -- nova '-e file:///opt/stack/nova#egg=nova'
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -e /opt/stack/nova
	sudo -H http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= /usr/local/bin/pip2.7 install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/nova/test-requirements.txt
	sudo chown -R pengsida /opt/stack/nova/nova.egg-info
	sudo install -D -m 0644 -o pengsida /opt/stack/nova/tools/nova-manage.bash_completion /etc/bash_completion.d/nova-manage.bash_completion
	
	# 清理nova
	# Delete rules
    sudo iptables -S -v | sed "s/-c [0-9]* [0-9]* //g" | grep "nova" | grep "\-A" |  sed "s/-A/-D/g" | awk '{print "sudo iptables",$0}' | bash
    # Delete nat rules
    sudo iptables -S -v -t nat | sed "s/-c [0-9]* [0-9]* //g" | grep "nova" |  grep "\-A" | sed "s/-A/-D/g" | awk '{print "sudo iptables -t nat",$0}' | bash
    # Delete chains
    sudo iptables -S -v | sed "s/-c [0-9]* [0-9]* //g" | grep "nova" | grep "\-N" |  sed "s/-N/-X/g" | awk '{print "sudo iptables",$0}' | bash
    # Delete nat chains
    sudo iptables -S -v -t nat | sed "s/-c [0-9]* [0-9]* //g" | grep "nova" |  grep "\-N" | sed "s/-N/-X/g" | awk '{print "sudo iptables -t nat",$0}' | bash
	
	# 删除instance
	instances=`sudo virsh list --all | grep $INSTANCE_NAME_PREFIX | sed "s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g"`
	echo $instances | xargs -n1 sudo virsh destroy || true
	echo $instances | xargs -n1 sudo virsh undefine --managed-save || true

	# Logout and delete iscsi sessions
	tgts=$(sudo iscsiadm --mode node | grep "vol-" | cut -d ' ' -f2)
	for target in $tgts; do
		sudo iscsiadm --mode node -T $target --logout || true
	done
	sudo iscsiadm --mode node --op delete || true
	
	# Clean out the instances directory.
	sudo rm -rf '/opt/stack/data/nova/instances/*'
	sudo rm -rf /opt/stack/data/nova /var/cache/nova

	# 配置nova
	sudo install -d -o pengsida /etc/nova
	
	# 配置rootwrap
	sudo rm -rf /etc/nova/rootwrap.d
	sudo install -d -o root -g root -m 755 /etc/nova/rootwrap.d
	sudo install -o root -g root -m 644 /opt/stack/nova/etc/nova/rootwrap.d/api-metadata.filters /opt/stack/nova/etc/nova/rootwrap.d/compute.filters /opt/stack/nova/etc/nova/rootwrap.d/network.filters /etc/nova/rootwrap.d
	sudo install -o root -g root -m 644 /opt/stack/nova/etc/nova/rootwrap.conf /etc/nova/rootwrap.conf
	sudo sed -e 's:^filters_path=.*$:filters_path=/etc/nova/rootwrap.d:' -i /etc/nova/rootwrap.conf
	
	# Set up the rootwrap sudoers
	rootwrap_bin="/usr/local/bin/nova-rootwrap"
	project="nova"
	STACK_USER="pengsida"
	tempfile=$(mktemp)
	bin_dir="/usr/local/bin"
    rootwrap_sudo_cmd="${rootwrap_bin} /etc/${project}/rootwrap.conf *"
    echo "$STACK_USER ALL=(root) NOPASSWD: $rootwrap_sudo_cmd" >$tempfile
	if [ -f ${bin_dir}/${project}-rootwrap-daemon ]; then
        rootwrap_sudo_cmd="${rootwrap_bin}-daemon /etc/${project}/rootwrap.conf"
        echo "$STACK_USER ALL=(root) NOPASSWD: $rootwrap_sudo_cmd" >>$tempfile
    fi
	chmod 0440 $tempfile
    sudo chown root:root $tempfile
    sudo mv $tempfile /etc/sudoers.d/${project}-rootwrap
	\end{lstlisting}
	
\end{document}