% !TeX spellcheck = en_US
%% 字体：方正静蕾简体
%%		 方正粗宋
\documentclass[a4paper,left=2.5cm,right=2.5cm,11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{fontspec}
\usepackage{cite}
\usepackage{xeCJK}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{longtable}
\usepackage{graphicx}
\usepackage{float}
\usepackage{rotating}
\usepackage{subfigure}
\usepackage{tabu}
\usepackage{amsmath}
\usepackage{setspace}
\usepackage{amsfonts}
\usepackage{appendix}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{geometry}
\setcounter{secnumdepth}{4}
\usepackage{mhchem}
\usepackage{multirow}
\usepackage{extarrows}
\usepackage{hyperref}
\titleformat*{\section}{\LARGE}
\renewcommand\refname{参考文献}
\renewcommand{\abstractname}{\sihao \cjkfzcs 摘{  }要}
%\titleformat{\chapter}{\centering\bfseries\huge\wryh}{}{0.7em}{}{}
%\titleformat{\section}{\LARGE\bf}{\thesection}{1em}{}{}
\titleformat{\subsection}{\Large\bfseries}{\thesubsection}{1em}{}{}
\titleformat{\subsubsection}{\large\bfseries}{\thesubsubsection}{1em}{}{}
\renewcommand{\contentsname}{{\cjkfzcs \centerline{目{  } 录}}}
\setCJKfamilyfont{cjkhwxk}{STXingkai}
\setCJKfamilyfont{cjkfzcs}{STSongti-SC-Regular}
% \setCJKfamilyfont{cjkhwxk}{华文行楷}
% \setCJKfamilyfont{cjkfzcs}{方正粗宋简体}
\newcommand*{\cjkfzcs}{\CJKfamily{cjkfzcs}}
\newcommand*{\cjkhwxk}{\CJKfamily{cjkhwxk}}
\newfontfamily\wryh{Microsoft YaHei}
\newfontfamily\hwzs{STZhongsong}
\newfontfamily\hwst{STSong}
\newfontfamily\hwfs{STFangsong}
\newfontfamily\jljt{MicrosoftYaHei}
\newfontfamily\hwxk{STXingkai}
% \newfontfamily\hwzs{华文中宋}
% \newfontfamily\hwst{华文宋体}
% \newfontfamily\hwfs{华文仿宋}
% \newfontfamily\jljt{方正静蕾简体}
% \newfontfamily\hwxk{华文行楷}
\newcommand{\verylarge}{\fontsize{60pt}{\baselineskip}\selectfont}  
\newcommand{\chuhao}{\fontsize{44.9pt}{\baselineskip}\selectfont}  
\newcommand{\xiaochu}{\fontsize{38.5pt}{\baselineskip}\selectfont}  
\newcommand{\yihao}{\fontsize{27.8pt}{\baselineskip}\selectfont}  
\newcommand{\xiaoyi}{\fontsize{25.7pt}{\baselineskip}\selectfont}  
\newcommand{\erhao}{\fontsize{23.5pt}{\baselineskip}\selectfont}  
\newcommand{\xiaoerhao}{\fontsize{19.3pt}{\baselineskip}\selectfont} 
\newcommand{\sihao}{\fontsize{14pt}{\baselineskip}\selectfont}      % 字号设置  
\newcommand{\xiaosihao}{\fontsize{12pt}{\baselineskip}\selectfont}  % 字号设置  
\newcommand{\wuhao}{\fontsize{10.5pt}{\baselineskip}\selectfont}    % 字号设置  
\newcommand{\xiaowuhao}{\fontsize{9pt}{\baselineskip}\selectfont}   % 字号设置  
\newcommand{\liuhao}{\fontsize{7.875pt}{\baselineskip}\selectfont}  % 字号设置  
\newcommand{\qihao}{\fontsize{5.25pt}{\baselineskip}\selectfont}    % 字号设置 

\usepackage{diagbox}
\usepackage{multirow}
\boldmath
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
\definecolor{cred}{rgb}{0.8,0.8,0.8}
\definecolor{cgreen}{rgb}{0,0.3,0}
\definecolor{cpurple}{rgb}{0.5,0,0.35}
\definecolor{cdocblue}{rgb}{0,0,0.3}
\definecolor{cdark}{rgb}{0.95,1.0,1.0}
\lstset{
	language=R,
	numbers=left,
	numberstyle=\tiny\color{black},
	showspaces=false,
	showstringspaces=false,
	basicstyle={\footnotesize}\ttfamily,
	keywordstyle=\color{cdocblue}\bfseries,
	commentstyle=\color{cgreen},
	stringstyle=\color{cred},
	frame=lines,
	escapeinside=``,
	xleftmargin=1em,
	xrightmargin=1em, 
	%backgroundcolor=\color{cdark},
	aboveskip=1em,
	breaklines=true,
	tabsize=4
} 

\newfontfamily{\consolas}{Consolas}
\newfontfamily{\monaco}{Monaco}
\setmonofont[Mapping={}]{Consolas}	%英文引号之类的正常显示，相当于设置英文字体
\setsansfont{Consolas} %设置英文字体 Monaco, Consolas,  Fantasque Sans Mono
\setmainfont{Times New Roman}

\setCJKmainfont{华文中宋}


\newcommand{\fic}[1]{\begin{figure}[H]
		\center
		\includegraphics[width=0.6\textwidth]{#1}
	\end{figure}}
	
\newcommand{\sizedfic}[2]{\begin{figure}[H]
		\center
		\includegraphics[width=#1\textwidth]{#2}
	\end{figure}}

% 改变段间隔
\setlength{\parskip}{0.2em}

\usepackage{lastpage}
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{\space \qquad \space}
\chead{第三次学习报告 \qquad}
\rhead{\qquad\thepage/\pageref{LastPage}}
\begin{document}

\section{中断和异常处理}
\subsection{异常和异常处理}
处理器为了实现处理异常和中断，使用了一个数据结构，也就是中断描述符表，用于存放中断描述符。同时处理器为每个异常和中断条件都赋予了一个向量，用于作为中断描述符表的索引号。\par
	中断可以从硬件和软件产生。外部中断通过INTR和NMI接收。NMI接收的中断是不可屏蔽中断，其向量号为2。INTR接收的外部中断可屏蔽，通过设置EFLAGS中的IF位为0来屏蔽这些中断。这里的IF标志可以通过STI和CLI来设置或清零。只有当程序的CPL(程序特权级)小于IOPL(I/O特权级字段)时，才可执行这两条指令。还有几种情况可以影响IF标志，比如PUSHF指令、IRET指令等。当通过中断门处理一个中断时，IF会被自动清零。\par
	软件中断主要借助INT指令，在指令操作数中提供中断向量号。向量号0到255都可以作为INT指令的中断号，比如指令INT 0x80可以执行系统中断。EFLAGS中的IF标志无法屏蔽软件中断。\par

\subsection{IDT和IDT描述符}
中断描述符表类似于全局描述符表，用于存放门描述符。处理器使用IDTR寄存器定位IDT表的位置，IDTR有48位，高32位是IDT表的基地址，而低16位为IDT的长度值。使用LIDT指令可以将内存中的基地址和限长值加载到IDTR寄存器中，不过该指令只能由CPL为0的代码执行。\par
	IDT存放的门描述符有三类，为中断门描述符、陷阱门描述符和任务门描述符，它们都是8字节的。中断门描述符和陷阱门描述符中存放了段选择符和偏移值，用于对段的寻址，从而将程序执行权转移到代码段中异常或中断的处理过程中。而任务门描述符中含有段选择符，不过没有偏移值，因为在门中的偏移值没有意义。\par

\subsection{异常与中断处理}
	发生异常或中断时，处理器使用异常或中断的向量作为IDT表的索引，从而得到相应的门描述符。门描述符中的段选择符指向GDT或IDT中的段描述符，而段描述符给出相应代码段的段基址。门描述符中的偏移值作为段基址的偏移，从而指向执行异常或中断处理过程的代码段。我觉得下面这张图描述得很形象。\par
	\begin{figure}[H]
		\center
		\includegraphics[width=0.53\textwidth]{1.png}
	\end{figure}
	
	异常或中断处理分为两种情况。一种是在高特权级下执行，一种是在同一特权级下执行。\par
		处理过程在高特权级上执行时，将会发生堆栈切换操作。此时处理器首先获得新栈的段选择符SS和栈指针ESP，这里的段选择符和栈指针由当前任务的TSS段提供。然后把原栈选择符和栈指针压入新栈。随后将EFLAGS、CS和EIP当前值压入新栈。如果异常会产生一个错误号，该错误号也将被压入新栈。如下图所示。\par
	\begin{figure}[H]
		\center
		\includegraphics[width=0.6\textwidth]{2.png}
	\end{figure}
	
	处理过程在同一特权级上执行时，过程相对简单。处理器将EFLAGS、CS和EIP当前值压入堆栈。如果异常会产生一个错误号，该错误号也会被压入堆栈。这个过程如下图所示。\par
	\begin{figure}[H]
		\center
		\includegraphics[width=0.6\textwidth]{3.png}
	\end{figure}
	
	中断处理过程结束时，程序使用IRET指令从中断处理过程中返回。此时处理器会从堆栈中弹出代码段的选择符CS和指令指针EIP。同时IRET会把保存的寄存器内容恢复到EFLAGS中。在特权级保护机制下，只有当CPL为0时，IOPL字段才会被恢复。只有CPL小等于IOPL时，IF标志才会被改变。如果中断处理过程中发生了堆栈切换，那么IRET指令会切换回原来的堆栈。\par
		需要注意的是，通过中断门访问异常或中断处理过程时，处理器会清零IF标志，随后再使用IRET指令恢复IF标志。而通过陷阱门访问处理过程则不会影响IF标志。\par

\subsection{错误码}
	错误码类似于段选择符，用于寻址段。不过这里的段是与特定的异常条件有关的。段错误码的格式如下所示。\par
	\begin{figure}[H]
		\center
		\includegraphics[width=0.5\textwidth]{4.png}
	\end{figure}
	
	图中的低三位为TI、IDT和EXT。EXT为0时，表示执行程序以外的事件造成了异常。IDT为0时，错误码的索引指向GDT或LDT的段描述符；当IDT为1时，错误码的索引指向IDT的一个门描述符。只有当TI为0时TI标志才有用。因为TI标志用于选择GDT表和LDT表。当TI为1时，错误码的索引部分指向LDT的段描述符；当TI为0时，错误码的索引部分指向GDT表中的描述符。\par
	错误码有一个特例，也就是页故障异常的错误码。页故障错误码中没有段选择符索引，只有最低3位比特位有效，分别为P、W/R和U/S。P=0时，表示也不存在；P为1时，表示违反页级保护权限。W/R=0时，表示读操作引起了异常；W/R=1时，表示异常由写操作引起。U/S=0时，表示异常发生时CPU正在执行超级用户代码；U/S=1时，表示异常发生时CPU正在执行一般用户代码。在第一次学习报告有提到过，CR2控制寄存器中存放着引起页面故障异常的线性地址。\par

\section{任务管理}
\subsection{用于任务管理的数据结构}
	为了进行任务管理，处理器定义了一些寄存器和数据结构，分别为任务状态段TSS、TSS描述符、任务寄存器TR和任务门描述符。\par
	用于恢复一个任务执行的处理器状态信息被保存在TSS中。TSS分为两类字段，一个是动态字段，还有一个是静态字段。当任务切换而被挂起时，处理器会更新动态字段的内容。而静态字段通常不会改变，它的字段内容在任务被创建时设置。\par
	TSS由任务状态段描述符来寻址和定义，以下是TSS段描述符的格式。
	\fic{5.png}
	
	描述符中的TYPE字段中的B标志用于表示任务是否处于忙状态。B=1时，表示任务正忙；B=0时，表示任务处于非活动状态。描述符中的G标志是颗粒度，当G=0时，TSS段的长度必须大等于104字节。描述符中的DPL标志用于特权级保护机制中。当发生任务切换时，访问TSS的程序的CPL必须小等于TSS中的DPL。描述符中的段基址就是任务状态段的基址。\par
	任务寄存器存放着段选择符和当前TSS段描述符。LTR指令可以在系统初始化阶段给TR寄存器加载初值，之后TR的内容会在任务切换时自动地被改变。\par
	除了使用段选择符直接访问GDT中的TSS描述符，还可以通过任务门描述符间接地访问TSS描述符，因为任务门描述符含有TSS选择符字段。任务门描述符中的DPL用于支持特权级保护机制。当程序通过任务门描述符调用程序时，程序的CPL以及指向任务门描述符的门选择符的RPL都必须小等于任务门描述符中的DPL。\par
	下图描述了调用任务的两种方式，一种是通过任务门描述符访问，一种是通过TSS段描述符访问。从图中可以看出，任务门描述符可以存放在GDT、LDT或IDT表中，程序通过任务门描述符间接访问到TSS描述符。
	\fic{6.png}
\subsection{任务切换}
	处理器可以通过4种方式进行任务切换操作，分别是：1.对TSS描述符执行JMP或CALL指令。2.对任务门描述符执行JMP或CALL指令。3.通过中断或异常向量指向任务门描述符。4.执行IRET指令。\par
	以下是进行任务切换的过程：
	\begin{itemize}
		\item 首先获得新任务的TSS段选择符。段选择符的获取有三种途径：1.从JMP或CALL指令操作数中获取。2.中断向量索引到IDT表中的任务门描述符，获取其中的TSS选择符。3.执行IRET指令时，从当前TSS的前一任务链接字段中获取。\par
		这里说一下前一任务链接字段，它需要和EFLAGS中的NT标志配合使用。NT标志为1时，表明当前任务嵌套在另一个任务中执行，并且当前任务的TSS段的前一任务链接字段中存放着高一层任务的TSS选择符。
		\item 经过特权级保护机制的检查。使用JMP或CALL调用程序时，当前任务的CPL和新任务的TSS段选择符的RPL必须小等于新任务TSS段描述符的DPL。发生中断、异常或使用IRET指令时，则无视特权级保护机制。
		\item 对B标志和NT标志的设置。如果使用JMP进行任务切换，则将B标志清零。如果使用IRET指令进行任务切换，则将B标志和NT标志清零。
		\item 将当前任务状态保存到当前任务的TSS中，包括所有通用寄存器的值，段寄存器中的段选择符，标志寄存器EFLAGS以及指令指针EIP。
		\item 加载新的TSS段描述符。如果任务切换由CALL、JMP、异常或者中断产生，则对新TSS段描述符中的B标志置1。
		\item 将新TSS的段选择符和描述符加载到任务寄存器中。同时设置CR0寄存器的任务已切换标志TS为1。
		\item 将新TSS状态加载进处理器，包括所有通用寄存器、段选择符、标志寄存器EFLAGS、LDTR寄存器、CR3寄存器以及EIP。如果任务切换由CALL、JMP、异常或者中断产生，则将EFLAGS中的NT位置一。
		\item 开始执行新任务。
	\end{itemize}
\subsection{任务地址空间}
	任务的地址空间由任务能够访问的段构成，这些段有代码段、数据段、堆栈段、TSS中引用的系统段以及任务代码能够访问的任何其他段。\par
	在任务之间共享数据有以下三个途径：
	\begin{itemize}
		\item 通过GDT共享数据。这个方法是很明显而且简单的。不同的段可以映射到相同的物理地址空间中，而每个段又有对应的段描述符。这些段描述符存放在GDT表中。于是任务通过GDT共享相同的物理地址空间。这种方法的缺点是所有任务都可以共享这些段中的代码和数据。
		\item 让任务共享相同的LDT。让一些特定的任务的TSS中LDT字段指向同一个LDT，从而访问到相同的物理地址空间。
		\item 让不同LDT中的某些段描述符映射到相同的物理地址。这样的段描述符通常被称为别名段。
	\end{itemize}
\subsection{编写保护模式}
\end{document}
